export default {
  async fetch(request, env) {
    const url = new URL(request.url);

    // 处理 OPTIONS 请求（CORS）
    if (request.method === "OPTIONS") {
      return new Response(null, {
        headers: {
          "Access-Control-Allow-Origin": "*",
          "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
          "Access-Control-Allow-Headers": "Content-Type"
        }
      });
    }

    // GET 请求：读取数据
    if (url.pathname === "/get" && request.method === "GET") {
      const category = url.searchParams.get("category");
      if (!category) {
        return new Response("Missing category parameter", { status: 400, headers: { "Access-Control-Allow-Origin": "*" } });
      }
      let data = await env.CONTENT_STORE.get(category);
      if (!data) {
        data = "[]";
      }
      return new Response(data, {
        status: 200,
        headers: {
          "Content-Type": "application/json",
          "Access-Control-Allow-Origin": "*"
        }
      });
    }

    // POST 请求：保存数据
    if (url.pathname === "/save" && request.method === "POST") {
      try {
        const body = await request.json();
        if (!body.category || !body.content) {
          return new Response("Missing parameters", { status: 400, headers: { "Access-Control-Allow-Origin": "*" } });
        }
        let history = await env.CONTENT_STORE.get(body.category, "json");
        if (!history) {
          history = [];
        }
        history.unshift({
          date: new Date().toISOString().split("T")[0],
          content: body.content
        });
        await env.CONTENT_STORE.put(body.category, JSON.stringify(history));
        return new Response("Success", { status: 200, headers: { "Access-Control-Allow-Origin": "*" } });
      } catch (err) {
        return new Response("Error: " + err.message, { status: 500, headers: { "Access-Control-Allow-Origin": "*" } });
      }
    }

    return new Response("Not found", { status: 404, headers: { "Access-Control-Allow-Origin": "*" } });
  }
};
